# 05. MVC 아키텍처

서블릿의 단점을 보완하기 위해 등장한 **JSP(JavaServer Page)** 라는 기술을 배워 보자.

여러 기법들이 다년간 다양한 업무 시스템에 적용되고 검증되어 좋은 방법이라고 증명되면, 우리는 이것을 **'최선의 관행(best practice)'** 이라고 부른다.

이번 장에서는 실무 웹 애플리케이션 개발에 있어 최선의 관행으로 알려진 **'MVC 아키텍처(Architecture)'** 에 대해 배워 보자.

<br>

# 5.1. MVC 이해하기

**MVC(model-view-controller)** 아키텍처의 구성 요소는 **모델(model), 뷰(view), 컨트롤러(controller)** 이다.

<br>

## 5.1.1. 올인원 All-in-one 방식과 문제점

이전 까지는 클라이언트의 요청 처리를 서블릿 홀로 담당하는 올인원 방식이였다. 즉, 서블릿이 혼자서 너무 많은 기능을 하는 방식이였다.

* **혼자서 너무 많은 기능을 하는 서블릿**

<img src="../capture/스크린샷 2019-09-09 오후 10.43.01.png">

<br>

이러한 올인원의 장점은 하나에 모든 기능이 들어가 있어서 크기를 작게 만들 수 있으나, 단점은 특정 한 곳이 고장이 나면 전체를 고쳐야 되므로 불편합니다.

그래서, 올인원 방식은 규모가 작거나 업무 변경이 많지 않은 경우에 적합하지만, 규모가 크거나 업무 변경이 잦은 경우에는 오히려 유지 보수가 어려워 운영 비용이 증가하게 됩니다.

요즘처럼 글로벌 비즈니스 환경에서는 더더욱 올인원 방식은 적합하지 않습니다.

<br>

## 5.1.2. 글로벌 환경과 MVC 아키텍처

시스템 변경이 잦은 상황에서 유지 보수를 보다 쉽게 하려면, **중복 코드의 작성을 최소화 하고, 코드 변경이 쉬워야 한다.** 이를 위해 기존 코드의 **재사용성을 높이는 방향으로** 설계해야 한다. 특히 객체지향의 특성을 십분 활용하여 좀 더 **역할을 세분화하고 역할 간 의존성을 최소화한다면,** 변화무쌍한 업무 환경에 대응하기 쉬운 시스템을 개발할 수 있다.

* **현재 대부분의 기업용 애플리케이션 개발에 적용되는 MVC 아키텍처 패턴**

<img src="../capture/스크린샷 2019-09-09 오후 11.00.21.png">

> MVC 구조에서는 클라이언트의 요청 처리를 서블릿 혼자서 담당하지 않고 세 개의 컴포넌트가 나누어 처리한다.

<br>

### MVC의 각 컴포넌트 역할

* **컨트롤러(controller) 컴포넌트의 역할** 
  * 클라이언트의 요청을 받았을 때 그 요청에 대해 실제 업무를 수행하는 <u>모델 컴포넌트를 호출하는 일</u>
  * 모델을 호출할 때 전달하기 쉽게 <u>데이터를 적절히 가공하는 일</u> 
  * 모델이 업무 수행을 완료하면, 그 결과를 가지고 화면을 생성하도록 <u>뷰에게 전달하는 일</u>

<br>

* **모델(model) 컴포넌트의 역할**
  * 데이터 저장소(예: 데이터베이스, 디렉터리 서비스 등)와  연동하여 <u>사용자가 입력한 데이터나 사용자에게 출력할 데이터를 다루는 일</u>
  * 여러 개의 데이터 변경 작업을 하나의 작업으로 묶은 <u>트랜잭션을 다루는 일</u>

<br>

* **뷰(view) 컴포넌트의 역할**
  * 모델이 처리한 데이터나 그 작업 결과를 가지고 사용자에게 <u>출력할 화면을 만드는 일</u>
  * HTML 과 CSS, JavaScript 를 사용하여 웹 브라우저가 출력할 <u>UI를 만드는 일</u>

<br>

### 높은 재사용성, 넓은 융통성

1. **룩앤필(look and feel)을** 쉽게 교체할 수 있다. 즉 화면 생성 부분을 별도의 컴포넌트로 분리하였기 때문에, 뷰 교체만으로 **사용자 화면을 손쉽게 바꿀 수 있다.**
2. **원 소스 멀티 유즈(one source multi use)를** 구현할 수 있다. 모델 컴포넌트가 작업한 결과를 다양한 뷰 컴포넌트를 통하여 PDF 나 HTML, XML, JSON(JavaScript Object) 등 **클라이언트가 원하는 형식으로 출력할 수 있다.**
3. **코드를 재사용할 수 있다.** 화면을 바꾸거나 데이터 형식을 바꾸더라도 모델 컴포넌트는 그대로 재사용할 수 있다.

<br>

### 빠른 개발, 저렴한 비용

1. 모델 컴포넌트를 재사용할 수 있기 때문에 **개발 속도가 빨리진다.** 
2. 컴포넌트를 쪼개게 되면, 그 컴포넌트의 난이도에 따라 좀 더 낮은 수준의 개발자를 투입할 수 있어서 **전체적인 개발 및 유지보수 비용을 줄일 수 있다.**

<br>

## 5.1.4. MVC 구동 원리

* **MVC 아키텍처를 적용한 전형적인 웹 애플리케이션의 예 (MVC 구조의 실행 흐름)**

  <img src="../capture/스크린샷 2019-09-09 오후 11.37.39.png">

  1. 웹 브라우저가 웹 애플리케이션 실행을 요청하면, **웹 서버가 그 요청을 받아서** 서블린 컨테이너(예: 톰켓 서버)에 넘겨 준다. **서블릿 컨테이너는 URL을 확인하여 그 요청을 처리할 서블릿을 찾아서 실행한다.**
  2. **서블릿은 실제 업무를 처리하는 모델 자바 객체의 메서드를 호출한다.** 만약 웹 브라우저가 보낸 데이터를 저장하거나 변경해야 한다면 그 **데이터를 가공하여 값 객체(VO; Value Object)를 생성하고, 모델 객체의 메서드를 호출할 때 인자값으로 넘긴다. **
  3. 모델 객체는 **JDBC를 사용하여 매개변수로 넘어온 값 객체를 데이터베이스에 저장하거나, 데이터베이스로부터 질의 결과를 가져와서 값 객체로 만들어 반환한다.** 이렇게 **값 객체는** 객체와 객체 사이에 데이터를 전달하는 용도로 사용하기 때문에 **'데이터 전송 객체(DTO; Data Transfer Object)'** 라도고 부른다.
  4. 서블릿은 모델 객체로부터 반환받은 값을 **JSP에 전달한다.**
  5. **JSP는** 서블릿으로부터 전달받은 **값 객체를 참조하여 웹 브라우저가 출력할 결과 화면을 만든다.** 그리고 **웹 브라우저에 출력함으로써 요청 처리를 완료한다.**
  6. 웹 브라우저는 서버로부터 받은 응답 내용을 화면에 출력한다.

  <br>

이처럼 MVC 아키텍처는 **서로 오고 가는 절차(트레이드오프: trade-off)** 가 많아서 복잡해 보일 수 있다. 하지만 코드들이 **역할 단위로 쪼개져 있어 유지 보수하기가 쉽다.**

<br>

# 5.2. 뷰 컴포넌트와 JSP

MVC 아키텍처에서 뷰 컴포넌트를 만들 때 보통 JSP를 사용한다. 뷰 컴포넌트의 역할은 웹 브라우저가 출력할 화면을 만드는 일이다. 그렇다면 **JSP는 화면 생성을 쉽게 해주는 기술이라고** 볼 수 있다.

<br>

## 5.2.1. JSP를 사용하는 이유

* **회원 등록 양식 화면의 일부**

  ```java
  @Override
  protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
    resp.setContentType("text/html; charset=UTF-8");
    PrintWriter out = resp.getWriter();
    out.println("<html><head><title>회원 등록</title></head>");
    out.println("<body><h1>회원 등록</h1>");
    out.println("<form action='add' method='post'>");
    out.println("이름: <input type='text' name='name'><br>");
    out.println("이메일: <input type='text' name='email'><br>");
    out.println("암호: <input type='password' name='password'><br>");
    out.println("<input type='submit' value='추가'>");
    out.println("<input type='reset' value='취소'>");
    out.println("</form>");
    out.println("</body></html>");
  }
  ```

  * HTML을 출력하려고 out.println() 를 호출하고 있다. 출력하는 문자열에 태그 속성이 포함되어 있는데 인용 부호(' ')로 인해 코드가 더 복잡해 보인다.

<br>

그래서 많은 양의 HTML을 out.println()을 사용하여 출력한다면 거의 재앙이라 할 수 있다. 그래서 이런 부분을 해소하고자 나온 기술이 **JSP** 이다.

<br>

## 5.2.2. JSP 구동 원리

JSP 기술의 가장 중요한 목적은 콘텐츠를 출력하는 **코딩을 단순화하는 것이다.**

* **JSP의 실행**

  <img src="../capture/스크린샷 2019-09-10 오전 12.01.23.png">

  1. 개발자는 **서버에 JSP 파일을 작성해 둔다.** 클라이언트가 JSP를 실행해 달라고 요청하면, **서블릿 컨테이너는 JSP 파일에 대응하는 자바 서블릿을 찾아서 실행한다.**
  2. 만약 JSP에 대응하는 서블릿이 없거나 JSP 파일이 변경되었다면, **JSP 엔진을 통해 JSP 파일을 해석하여 서블릿 자바 소스를 생성한다.**
  3. **서블릿 자바 소스는 자바 컴파일러를 통해 서블릿 클래스 파일로 컴파일된다.** JSP 파일을 바꿀 때 마다 이 과정을 반복한다.
  4. JSP 로부터 생성된 서블릿은 서블릿 구동 방식에 따라 실행된다. 즉 **서블릿의 service() 메서드가 호출되고, 출력 메서드를 통해 서블릿이 생성한 HTML 화면을 웹 브라우저로 보낸다.**

<br>

JSP를 사용하면 HTML을 작성하기 쉬워지므로 **뷰 컴포넌트를 만들 때 주로 사용된다.** 즉, **JSP는 서블릿 자바 파일을 만들기 위한 템플릿으로 사용된다.**

<br>

## 5.2.3. JSP의 구동 과정 확인

* **web/WEB-INF/web.xml**

  ```xml
  ...
  <!-- welcomefile 추가 -->
  <welcome-file-list>
    <welcome-file>hello.jsp</welcome-file>
  </welcome-file-list>
  ...
  ```

* **web/hello.jsp**

  ```jsp
  <%--
    Created by IntelliJ IDEA.
    User: sangminlee
    Date: 10/09/2019
      Time: 12:12 오전
    To change this template use File | Settings | File Templates.
        --%>
  <%@ page contentType="text/html;charset=UTF-8" language="java" %>
  <html>
    <head>
      <title>Hello</title>
    </head>
    <body>
      <p>안녕하세요</p>
    </body>
  </html>
  ```

* **결과확인**

  <img src="../capture/스크린샷 2019-09-10 오전 12.16.28.png" width=500>

**JSP를 실행할 때 비로소 JSP 엔진은 서블릿을 만든다.** 즉, JSP가 직접 실행되는 것이 아니라 JSP로부터 만들어진 서블릿이 실행된다.

<br>

## 5.2.4. HttpJspPage 인터페이스

JSP 엔진은 JSP 파일로부터 서블릿 클래스를 생성할 때 HttpJspPage 인터페이스를 구현한 클래스를 만든다.

* **HttpJspPage 인터페이스의 상속 관계**

  